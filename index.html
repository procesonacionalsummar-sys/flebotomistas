<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador de Misiones - Flebotomista SYNLAB</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      line-height: 1.5;
      background: #f5f7fb;
    }
    h1, h2 {
      text-align: center;
    }
    .card {
      background: #ffffff;
      border: 1px solid #d0d4e4;
      border-radius: 12px;
      padding: 18px;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .options button {
      display: block;
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #b5b9cf;
      cursor: pointer;
      text-align: left;
      font-size: 0.95rem;
      background: #f8f9ff;
    }
    .options button:hover:not(:disabled) {
      background: #ecefff;
    }
    .options button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .feedback {
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }
    .hidden {
      display: none;
    }
    .btn-primary {
      margin-top: 10px;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #4c6fff;
      color: white;
      font-weight: bold;
    }
    .btn-primary:hover {
      background: #3b57cc;
    }
    .btn-secondary {
      margin-top: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #e0e4ff;
      color: #333;
      font-size: 0.8rem;
    }
    .btn-secondary:hover {
      background: #c6cdfc;
    }
    #progress-text {
      font-size: 0.9rem;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>Misiones SYNLAB ‚Äì Rol Flebotomista ü©∏</h1>
  <p style="text-align:center; max-width: 650px; margin: 0 auto;">
    Entrar√°s en varias misiones cortas. Solo marca lo que se parece m√°s a ti.
    No ver√°s notas ni resultados, solo un cierre de historia.
  </p>

  <!-- Pantalla inicial -->
  <div id="start-screen" class="card">
    <h2>Antes de empezar</h2>
    <label for="participant-id">ID del jugador (c√≥digo, no nombre real):</label><br />
    <input type="text" id="participant-id" placeholder="Ej: P001" />
    <br /><br />
    <button class="btn-primary" onclick="startSimulation()">Comenzar misiones</button>
    <p style="font-size: 0.9em; color: #555; margin-top:8px;">
      Usa c√≥digos an√≥nimos (P001, P002, etc.) para mantener la confidencialidad.
    </p>
  </div>

  <!-- Contenedor del juego -->
  <div id="scenario-card" class="card hidden">
    <h2 id="scenario-title">Misi√≥n</h2>
    <p id="progress-text"></p>
    <p id="scenario-text"></p>

    <div id="options-container" class="options"></div>

    <div id="feedback" class="feedback"></div>

    <button id="next-button" class="btn-primary hidden" onclick="nextScenario()">
      Siguiente misi√≥n ‚ñ∂
    </button>
  </div>

  <!-- Resultados finales (vista candidato) -->
  <div id="results-card" class="card hidden">
    <h2>Misiones completadas</h2>
    <p id="summary"></p>
    <p style="font-size:0.9rem; color:#555;">
      Gracias por participar. Puedes avisar a la persona responsable del proceso que ya terminaste.
    </p>

    <!-- Bot√≥n peque√±o para acceso restringido -->
    <button id="admin-access-btn" class="btn-secondary" onclick="requestAdminAccess()">
      Acceso para equipo de selecci√≥n
    </button>

    <!-- Secci√≥n de descarga solo visible tras contrase√±a correcta -->
    <div id="download-section" class="hidden" style="margin-top:10px;">
      <p style="font-size:0.8rem; color:#555;">
        Acceso autorizado. Descarga el archivo de resultados para an√°lisis interno.
      </p>
      <button class="btn-primary" onclick="downloadCSV()">
        Descargar resultados (.csv)
      </button>
    </div>
  </div>

  <script>
    // =========================
    // 1. Escenarios del juego
    // =========================
    // Categor√≠as:
    //  - AGIL, CONECTAR, COMUNICAR, EJECUTAR (modelo ACCE)
    //  - PSICO (bloque ansiedad / depresi√≥n / abandono)
    var scenarios = [
      // -------- A: √ÅGIL --------
      {
        id: "AGIL1_SistemaCaido",
        category: "AGIL",
        dimension: "escucha_cliente_adapta",
        title: "Misi√≥n 1: Sistema caprichoso",
        text:
          "Acabas de tomar asiento en la sala de extracciones. El sistema se cae justo cuando entra un paciente mirando el reloj: dice que tiene muy poco tiempo antes de irse a trabajar.",
        options: [
          {
            id: "A",
            label:
              "Le explicas que sin sistema no puedes hacer nada y que tendr√° que volver otro d√≠a.",
            correct: false,
            feedback:
              "La respuesta es muy r√≠gida: protege protocolos, pero no explora alternativas seguras para ayudar al paciente."
          },
          {
            id: "B",
            label:
              "Le explicas la situaci√≥n, revisas qu√© puedes adelantar (preparar material, verificar identidad) y pides apoyo a un compa√±ero para que en cuanto vuelva el sistema se complete r√°pido.",
            correct: true,
            feedback:
              "Combina cuidado por el paciente con adaptaci√≥n al contratiempo y trabajo en equipo."
          },
          {
            id: "C",
            label:
              "Decides usar papeles y notas improvisadas para avanzar igual, con la idea de subir todo al sistema despu√©s.",
            correct: false,
            feedback:
              "La intenci√≥n de ayudar es alta, pero el riesgo de errores en trazabilidad aumenta."
          }
        ]
      },
      {
        id: "AGIL2_VenasDificiles",
        category: "AGIL",
        dimension: "riesgos_calculados",
        title: "Misi√≥n 2: Venas que se esconden",
        text:
          "Llega una paciente que comenta que siempre ha tenido venas dif√≠ciles y malas experiencias en extracciones anteriores. La sala est√° llena y hay algo de presi√≥n por el tiempo.",
        options: [
          {
            id: "A",
            label:
              "Eliges la t√©cnica que conoces como menos molesta, explicas lo que vas a hacer y te tomas un momento para que se sienta tranquila, aunque tardes un poco m√°s.",
            correct: true,
            feedback:
              "Equilibras confort del paciente, calidad t√©cnica y ritmo de trabajo."
          },
          {
            id: "B",
            label:
              "Usas una t√©cnica m√°s r√°pida, aunque algo m√°s invasiva, para que la sala no se retrase demasiado.",
            correct: false,
            feedback:
              "La prioridad va al tiempo por encima de la experiencia de la paciente."
          },
          {
            id: "C",
            label:
              "Prefieres no tocar el caso y pides de inmediato que otro compa√±ero se encargue sin valorar t√∫ primero la situaci√≥n.",
            correct: false,
            feedback:
              "La prudencia es v√°lida, pero aqu√≠ aparece una retirada demasiado r√°pida de la responsabilidad."
          }
        ]
      },
      {
        id: "AGIL3_CambioTurno",
        category: "AGIL",
        dimension: "adaptacion_cambio",
        title: "Misi√≥n 3: Cambio de horario inesperado",
        text:
          "Te informan que, por unos d√≠as, se modificar√° la forma de organizar los turnos de extracci√≥n para probar una nueva din√°mica de atenci√≥n.",
        options: [
          {
            id: "A",
            label:
              "Te tomas un tiempo para entender el nuevo esquema, haces preguntas y pruebas c√≥mo funciona en tu d√≠a a d√≠a.",
            correct: true,
            feedback:
              "Aceptas el cambio y te involucras en entenderlo antes de juzgarlo."
          },
          {
            id: "B",
            label:
              "Te quejas con algunos compa√±eros y, cuando puedes, sigues organiz√°ndote como antes.",
            correct: false,
            feedback:
              "Se crea un doble sistema entre lo nuevo y lo viejo, lo que puede generar confusi√≥n."
          },
          {
            id: "C",
            label:
              "Dices que ese cambio no te sirve y que t√∫ seguir√°s con tu rutina habitual.",
            correct: false,
            feedback:
              "La respuesta es muy r√≠gida y se distancia de la adaptaci√≥n que requiere el entorno."
          }
        ]
      },

      // -------- C: CONECTAR --------
      {
        id: "CON1_MedicoMolesto",
        category: "CONECTAR",
        dimension: "puentes_medicos_negocio",
        title: "Misi√≥n 4: Puente con el m√©dico",
        text:
          "Un m√©dico llega a la sala de extracciones visiblemente molesto porque algunas muestras anteriores llegaron tarde al laboratorio.",
        options: [
          {
            id: "A",
            label:
              "Respondes de forma breve y evitas la conversaci√≥n para que no se escale el conflicto.",
            correct: false,
            feedback:
              "Se evita la tensi√≥n, pero tambi√©n se pierde la oportunidad de mejorar la coordinaci√≥n."
          },
          {
            id: "B",
            label:
              "Escuchas lo que comenta, explicas con calma qu√© ocurri√≥ y propones juntos una forma de organizar mejor el flujo de muestras.",
            correct: true,
            feedback:
              "Construyes puentes entre √°reas, integrando su preocupaci√≥n con opciones de mejora."
          },
          {
            id: "C",
            label:
              "Le dices que eso no es asunto tuyo y que lo hable con otra √°rea.",
            correct: false,
            feedback:
              "La responsabilidad se desplaza del todo fuera, y la relaci√≥n entre servicios se enfr√≠a."
          }
        ]
      },
      {
        id: "CON2_ApoyoCompanero",
        category: "CONECTAR",
        dimension: "colaboracion_equipo",
        title: "Misi√≥n 5: Compa√±ero en apuros",
        text:
          "Un compa√±ero nuevo est√° teniendo dificultades para organizar bien el etiquetado y se le nota algo tenso.",
        options: [
          {
            id: "A",
            label:
              "Le dices que con el tiempo se acostumbrar√°, pero sigues concentrado en tus propias muestras.",
            correct: false,
            feedback:
              "No hay mala intenci√≥n, pero tampoco se traduce en apoyo concreto."
          },
          {
            id: "B",
            label:
              "Te acercas, le muestras un modo pr√°ctico de organizarse que a ti te funciona y revisan juntos algunas muestras.",
            correct: true,
            feedback:
              "Compartes experiencia y conocimiento, facilitando su aprendizaje."
          },
          {
            id: "C",
            label:
              "Llamas al supervisor para que sea √©l quien lo acompa√±e en todo el proceso.",
            correct: false,
            feedback:
              "Puede ser √∫til, pero tambi√©n se pierde una oportunidad de v√≠nculo directo con el compa√±ero."
          }
        ]
      },
      {
        id: "CON3_Sedes",
        category: "CONECTAR",
        dimension: "trabajo_transversal",
        title: "Misi√≥n 6: Trabajo entre sedes",
        text:
          "Te proponen participar en una peque√±a iniciativa para unificar buenas pr√°cticas de extracci√≥n entre varias sedes.",
        options: [
          {
            id: "A",
            label:
              "Aceptas participar, compartes lo que haces bien y tambi√©n escuchas las ideas de otras sedes.",
            correct: true,
            feedback:
              "Hay apertura para dar y recibir aprendizajes a nivel transversal."
          },
          {
            id: "B",
            label:
              "Prefieres centrarte solo en tu sede porque ya tienes suficiente trabajo.",
            correct: false,
            feedback:
              "Cuidas tu carga, pero pierdes impacto en la red m√°s amplia."
          },
          {
            id: "C",
            label:
              "Aceptas solo para estar informado, pero decides no intervenir mucho en las reuniones.",
            correct: false,
            feedback:
              "Te mantienes al margen y limitas tu contribuci√≥n a la conexi√≥n entre equipos."
          }
        ]
      },

      // -------- C: COMUNICAR --------
      {
        id: "COM1_RepetirMuestra",
        category: "COMUNICAR",
        dimension: "comunicacion_paciente",
        title: "Misi√≥n 7: Muestra repetida",
        text:
          "Necesitas repetir una muestra a un paciente porque la anterior no fue v√°lida. El paciente te pregunta, algo molesto, por qu√© tiene que pasar por lo mismo otra vez.",
        options: [
          {
            id: "A",
            label:
              "Le dices que son √≥rdenes del sistema y que no sabes m√°s.",
            correct: false,
            feedback:
              "La comunicaci√≥n queda muy corta y aumenta la sensaci√≥n de desconfianza."
          },
          {
            id: "B",
            label:
              "Le explicas en lenguaje sencillo que repetir la muestra es importante para asegurar un resultado confiable y que es algo que a veces ocurre.",
            correct: true,
            feedback:
              "Se cuida la informaci√≥n y la tranquilidad del paciente al mismo tiempo."
          },
          {
            id: "C",
            label:
              "Le das una explicaci√≥n larga llena de detalles t√©cnicos para que entienda el proceso.",
            correct: false,
            feedback:
              "La intenci√≥n es buena, pero el exceso de tecnicismo puede generar m√°s confusi√≥n."
          }
        ]
      },
      {
        id: "COM2_RetroCoordinadora",
        category: "COMUNICAR",
        dimension: "feedback_equipo",
        title: "Misi√≥n 8: Conversaci√≥n con la coordinadora",
        text:
          "Tu coordinadora te pregunta en una reuni√≥n breve c√≥mo te est√°s sintiendo en el equipo y si ves algo a mejorar.",
        options: [
          {
            id: "A",
            label:
              "Respondes que todo est√° perfecto, aunque no sea del todo cierto, para no entrar en temas inc√≥modos.",
            correct: false,
            feedback:
              "Se evita el conflicto, pero tambi√©n se pierde una oportunidad de mejora y de confianza mutua."
          },
          {
            id: "B",
            label:
              "Comentas lo que valoras del equipo y se√±alas de forma respetuosa alg√∫n punto que crees que podr√≠a mejorarse.",
            correct: true,
            feedback:
              "Aporta informaci√≥n √∫til y cuida la relaci√≥n con la coordinaci√≥n."
          },
          {
            id: "C",
            label:
              "Aprovechas para enumerar varios problemas que te molestan sin plantear alternativas.",
            correct: false,
            feedback:
              "La comunicaci√≥n se centra en la queja y puede tensar el clima si no se acompa√±a de propuestas."
          }
        ]
      },
      {
        id: "COM3_CompaneraApagada",
        category: "COMUNICAR",
        dimension: "empatia_escucha",
        title: "Misi√≥n 9: Compa√±era apagada",
        text:
          "Notas que una compa√±era que normalmente es participativa est√° m√°s callada, distra√≠da y comete peque√±os descuidos.",
        options: [
          {
            id: "A",
            label:
              "Ignoras la situaci√≥n porque piensas que son cosas personales y no quieres involucrarte.",
            correct: false,
            feedback:
              "Respetar el espacio ajeno es importante, pero tambi√©n lo es ofrecer apoyo m√≠nimo cuando hay se√±ales claras."
          },
          {
            id: "B",
            label:
              "Buscas un momento tranquilo y le preguntas c√≥mo se siente, ofreci√©ndote a escuchar si quiere hablar.",
            correct: true,
            feedback:
              "Se combina respeto por su espacio con una puerta abierta a la conversaci√≥n y apoyo."
          },
          {
            id: "C",
            label:
              "Comentas con otros compa√±eros que la ves rara, para ver si alguien m√°s sabe qu√© le pasa.",
            correct: false,
            feedback:
              "La preocupaci√≥n es genuina, pero se transforma m√°s en comentario entre terceros que en apoyo directo."
          }
        ]
      },

      // -------- E: EJECUTAR --------
      {
        id: "EJE1_Prioridades",
        category: "EJECUTAR",
        dimension: "metas_priori_resultados",
        title: "Misi√≥n 10: Tetris de tareas",
        text:
          "Tienes varios pacientes en espera y, al mismo tiempo, te piden preparar una caja de muestras que debe salir en el pr√≥ximo env√≠o.",
        options: [
          {
            id: "A",
            label:
              "Te dejas llevar por lo primero que te piden y vas resolviendo en el orden en que van llegando las cosas.",
            correct: false,
            feedback:
              "Se avanza, pero sin una prioridad clara; es f√°cil perder de vista lo m√°s urgente."
          },
          {
            id: "B",
            label:
              "Revisas qu√© pacientes y tareas son m√°s cr√≠ticas, organizas un orden l√≥gico y explicas brevemente c√≥mo te vas a organizar si alguien pregunta.",
            correct: true,
            feedback:
              "Se combinan resultados, planificaci√≥n y comunicaci√≥n clara de prioridades."
          },
          {
            id: "C",
            label:
              "Dejas en pausa a los pacientes para dedicarte primero a la caja urgente y evitar problemas con el supervisor.",
            correct: false,
            feedback:
              "Se resuelve la urgencia del supervisor, pero el impacto en la experiencia de quienes esperan es alto."
          }
        ]
      },
      {
        id: "EJE2_CompromisoEntrega",
        category: "EJECUTAR",
        dimension: "cumple_promesas",
        title: "Misi√≥n 11: Peque√±o informe pendiente",
        text:
          "Prometiste entregar al final del turno un peque√±o registro de incidencias, pero el d√≠a se alarga y est√°s cansado/a.",
        options: [
          {
            id: "A",
            label:
              "Decides dejarlo para el d√≠a siguiente sin avisar, porque ya no te da la energ√≠a.",
            correct: false,
            feedback:
              "El compromiso se pospone sin comunicaci√≥n, lo que puede generar confusi√≥n o p√©rdida de informaci√≥n."
          },
          {
            id: "B",
            label:
              "Avisas que necesitas unos minutos m√°s para completarlo y lo entregas antes de irte.",
            correct: true,
            feedback:
              "Mantienes la promesa y gestionas el tiempo de forma clara."
          },
          {
            id: "C",
            label:
              "Lo entregas r√°pido, aunque incompleto, para cumplir con la hora acordada.",
            correct: false,
            feedback:
              "Se cumple el plazo, pero la calidad de la informaci√≥n puede verse afectada."
          }
        ]
      },
      {
        id: "EJE3_AsistenciaPuntualidad",
        category: "EJECUTAR",
        dimension: "fiabilidad_basica",
        title: "Misi√≥n 12: Ma√±anas complicadas",
        text:
          "Durante algunas semanas has tenido dificultades con el transporte y llegas justo o un poco tarde a varios turnos de la ma√±ana.",
        options: [
          {
            id: "A",
            label:
              "Asumes que son cosas que pasan y procuras llegar a la hora cuando se pueda.",
            correct: false,
            feedback:
              "El impacto en el equipo y en los pacientes queda poco considerado."
          },
          {
            id: "B",
            label:
              "Buscas alternativas (otros horarios, rutas, organizaci√≥n) y, si ves que va a seguir ocurriendo, hablas con tu coordinador para encontrar una soluci√≥n.",
            correct: true,
            feedback:
              "Se reconoce el problema y se busca activamente una salida antes de que crezca."
          },
          {
            id: "C",
            label:
              "No comentas nada, pero pides con m√°s frecuencia cambios de turno para evitar las ma√±anas.",
            correct: false,
            feedback:
              "Se intenta esquivar el problema m√°s que enfrentarlo de manera abierta."
          }
        ]
      },

      // -------- BLOQUE PSICOL√ìGICO (ANSIEDAD / DEPRESI√ìN / ABANDONO) --------
      {
        id: "PSICO1_AnsiedadAnticipatoria",
        category: "PSICO",
        dimension: "ansiedad_anticipatoria",
        title: "Misi√≥n 13: Espera larga",
        text:
          "Est√°s esperando una noticia importante (resultado, respuesta de alguien, decisi√≥n). Faltan varios d√≠as y la situaci√≥n no se resolver√° antes.",
        options: [
          {
            id: "A",
            label:
              "Piensas en el tema muchas veces al d√≠a, revisas el tel√©fono y repasas posibles escenarios, aunque intentes hacer otras cosas.",
            correct: false,
            feedback:
              "La espera ocupa bastante espacio mental y cuesta dejarla del todo al margen."
          },
          {
            id: "B",
            label:
              "Te preguntas qu√© est√° en tu mano, organizas eso y luego intentas seguir con tu rutina, aunque el tema vuelva a tu cabeza a ratos.",
            correct: true,
            feedback:
              "La preocupaci√≥n existe, pero buscas un equilibrio entre control y rutina."
          },
          {
            id: "C",
            label:
              "Evitas abrir correos o mensajes relacionados hasta el √∫ltimo momento para no sentirte mal antes de tiempo.",
            correct: false,
            feedback:
              "La informaci√≥n se posterga, pero la tensi√≥n queda en segundo plano latente."
          }
        ]
      },
      {
        id: "PSICO2_EstadoAnimo",
        category: "PSICO",
        dimension: "estado_animo_bajo",
        title: "Misi√≥n 14: Semanas grises",
        text:
          "Imagina que durante varias semanas te notas con menos energ√≠a y menos ganas de hacer cosas que normalmente disfrutas.",
        options: [
          {
            id: "A",
            label:
              "Piensas que es una racha sin importancia, no lo comentas con nadie y sigues igual esperando que pase.",
            correct: false,
            feedback:
              "El malestar se normaliza sin tener demasiado espacio para ser revisado."
          },
          {
            id: "B",
            label:
              "Empiezas por hacer peque√±os ajustes (sue√±o, actividades, organizaci√≥n) y, si ves que se mantiene, considerar√≠as hablarlo con alguien o pedir ayuda profesional.",
            correct: true,
            feedback:
              "Das un lugar al malestar sin dramatizarlo, pero tampoco lo ignoras."
          },
          {
            id: "C",
            label:
              "Te enfadas contigo mismo/a por sentirte as√≠ y te exiges rendir igual o m√°s que antes.",
            correct: false,
            feedback:
              "La respuesta va m√°s hacia la autoexigencia que hacia el cuidado."
          }
        ]
      },
      {
        id: "PSICO3_SuenoCansancio",
        category: "PSICO",
        dimension: "autocuidado_basico",
        title: "Misi√≥n 15: Cansancio acumulado",
        text:
          "Durante varias semanas duermes peor y te levantas con sensaci√≥n de no haber descansado. Empiezas a notarlo en tu concentraci√≥n.",
        options: [
          {
            id: "A",
            label:
              "Aumentas el consumo de caf√© u otros estimulantes y tratas de mantener el ritmo sin tocar mucho tu rutina.",
            correct: false,
            feedback:
              "El cuerpo recibe m√°s empuje, pero el descanso de fondo no mejora."
          },
          {
            id: "B",
            label:
              "Intentas ajustar horarios, h√°bitos de sue√±o y, si persiste, considerar√≠as consultar con un profesional.",
            correct: true,
            feedback:
              "El cansancio se toma como algo a revisar y no solo como algo que ‚Äòhay que aguantar‚Äô."
          },
          {
            id: "C",
            label:
              "Reduces actividades poco a poco y pasas m√°s tiempo en casa, sin un plan claro de qu√© hacer con ese cansancio.",
            correct: false,
            feedback:
              "La vida se va estrechando alrededor del cansancio."
          }
        ]
      },
      {
        id: "PSICO4_AbandonoPuesto",
        category: "PSICO",
        dimension: "abandono_puesto",
        title: "Misi√≥n 16: Ruido en el trabajo",
        text:
          "En un trabajo nuevo, durante varias semanas hay roces, cambios de turno inesperados y decisiones con las que no est√°s de acuerdo.",
        options: [
          {
            id: "A",
            label:
              "Empiezas a llegar tarde o faltar de vez en cuando mientras vas mirando otras opciones.",
            correct: false,
            feedback:
              "La salida se va dando de forma silenciosa a trav√©s del compromiso con la asistencia."
          },
          {
            id: "B",
            label:
              "Buscas un momento para hablar con quien coordina, aclarar lo que se puede ajustar y, seg√∫n eso, decides si quedarte o no.",
            correct: true,
            feedback:
              "Antes de cortar el v√≠nculo, exploras si hay margen de cambio."
          },
          {
            id: "C",
            label:
              "Cuando sientes que algo ya no encaja, prefieres renunciar de forma r√°pida sin extender demasiado el proceso.",
            correct: false,
            feedback:
              "La salida tiende a ser m√°s brusca cuando sientes que la situaci√≥n te supera."
          }
        ]
      },
      {
        id: "PSICO5_AutoimagenCompromiso",
        category: "PSICO",
        dimension: "autoinforme_compromiso",
        title: "Misi√≥n 17: C√≥mo te describes en compromisos",
        text:
          "Pensando en los √∫ltimos a√±os, cuando te comprometes con proyectos o actividades de cierta duraci√≥n, ¬øqu√© se parece m√°s a ti?",
        options: [
          {
            id: "A",
            label:
              "Casi siempre termino todo lo que empiezo y es muy raro que abandone algo, aunque no tenga mucho sentido seguir.",
            correct: false,
            feedback:
              "Te describes con un nivel muy alto de cumplimiento, casi sin margen para soltar algo a tiempo."
          },
          {
            id: "B",
            label:
              "Suelo terminar lo que empiezo, aunque alguna vez he decidido dejar algo cuando ya no aportaba o las condiciones cambiaron mucho.",
            correct: true,
            feedback:
              "Hay una autoimagen de continuidad, pero con algo de flexibilidad."
          },
          {
            id: "C",
            label:
              "Arranco muchas cosas con ganas, pero me cuesta llegar al final si la motivaci√≥n baja.",
            correct: false,
            feedback:
              "Reconoces m√°s dificultad para sostener proyectos en el tiempo."
          }
        ]
      },
      {
        id: "PSICO6_ApoyoSocial",
        category: "PSICO",
        dimension: "apoyo_social_buscado",
        title: "Misi√≥n 18: Manejar el estr√©s",
        text:
          "Cuando te sientes sobrepasado/a por estr√©s laboral o personal, ¬øqu√© suele ocurrir m√°s seguido?",
        options: [
          {
            id: "A",
            label:
              "Procuro que nadie lo note, no suelo contarlo y prefiero aguantar hasta que se pase.",
            correct: false,
            feedback:
              "El malestar se maneja principalmente hacia dentro y en soledad."
          },
          {
            id: "B",
            label:
              "Busco a alguien de confianza para comentar c√≥mo me siento y, si es necesario, pedir ayuda o apoyo.",
            correct: true,
            feedback:
              "El estr√©s se comparte y se reparte con la red de apoyo."
          },
          {
            id: "C",
            label:
              "Acumulo bastante y cuando exploto o me desbordo, ah√≠ reci√©n comento algo.",
            correct: false,
            feedback:
              "El malestar se acumula hasta encontrar una salida brusca."
          }
        ]
      }
    ];

    // =========================
    // 2. Estado del simulador
    // =========================
    var currentScenarioIndex = 0;
    var responses = [];
    var currentQuestionStartTime = null;
    var participantId = "";
    var storyLog = [];

    var scenarioQueue = [];
    var scenarioMap = {};
    for (var i = 0; i < scenarios.length; i++) {
      scenarioMap[scenarios[i].id] = scenarios[i];
    }

    function scheduleScenario(id) {
      if (scenarioMap[id] && scenarioQueue.indexOf(id) === -1) {
        scenarioQueue.push(id);
      }
    }

    // =========================
    // 3. Historia interna (para HR)
    // =========================
    function getStoryFragment(scenario, option) {
      var id = scenario.id;
      var op = option.id;

      // AGIL
      if (id === "AGIL1_SistemaCaido") {
        if (op === "A") return "Ante la ca√≠da del sistema respondi√≥ de forma muy r√≠gida, sin explorar alternativas seguras para el paciente.";
        if (op === "B") return "Con el sistema ca√≠do combin√≥ calma con adaptaci√≥n y apoyo del equipo para ayudar al paciente.";
        if (op === "C") return "Ante la ca√≠da del sistema eligi√≥ improvisar con papeles, aumentando el riesgo en trazabilidad.";
      }
      if (id === "AGIL2_VenasDificiles") {
        if (op === "A") return "Ante una paciente con venas dif√≠ciles prioriz√≥ la comodidad y la explicaci√≥n, aun con presi√≥n de tiempo.";
        if (op === "B") return "Con venas dif√≠ciles prioriz√≥ la rapidez aunque la t√©cnica fuera m√°s inc√≥moda.";
        if (op === "C") return "Ante un caso complejo se retir√≥ pronto y deleg√≥ sin valorar primero la situaci√≥n.";
      }
      if (id === "AGIL3_CambioTurno") {
        if (op === "A") return "Frente a un cambio de turnos eligi√≥ entender y probar el nuevo esquema antes de juzgarlo.";
        if (op === "B") return "Frente a un cambio de turnos combin√≥ queja con mantener su forma antigua cuando pod√≠a.";
        if (op === "C") return "Rechaz√≥ abiertamente el cambio en la organizaci√≥n de turnos.";
      }

      // CONECTAR
      if (id === "CON1_MedicoMolesto") {
        if (op === "A") return "Ante la queja de un m√©dico opt√≥ por una respuesta m√≠nima para evitar la conversaci√≥n.";
        if (op === "B") return "Ante la queja de un m√©dico escuch√≥, explic√≥ lo ocurrido y propuso mejoras conjuntas.";
        if (op === "C") return "Ante la queja de un m√©dico traslad√≥ toda la responsabilidad a otra √°rea.";
      }
      if (id === "CON2_ApoyoCompanero") {
        if (op === "A") return "Con un compa√±ero en dificultad prefiri√≥ no involucrarse m√°s all√° de un comentario tranquilizador.";
        if (op === "B") return "Con un compa√±ero en dificultad ofreci√≥ apoyo directo y comparti√≥ una forma de organizarse mejor.";
        if (op === "C") return "Ante un compa√±ero en dificultad deriv√≥ todo el acompa√±amiento al supervisor.";
      }
      if (id === "CON3_Sedes") {
        if (op === "A") return "Acept√≥ participar activamente en una iniciativa entre sedes para compartir buenas pr√°cticas.";
        if (op === "B") return "Rechaz√≥ involucrarse en iniciativas entre sedes por carga de trabajo.";
        if (op === "C") return "Particip√≥ de forma muy pasiva en las reuniones entre sedes.";
      }

      // COMUNICAR
      if (id === "COM1_RepetirMuestra") {
        if (op === "A") return "Ante la repetici√≥n de una muestra ofreci√≥ una explicaci√≥n muy limitada al paciente.";
        if (op === "B") return "Ante la repetici√≥n de una muestra explic√≥ de forma sencilla y calmada la necesidad del procedimiento.";
        if (op === "C") return "Ante la repetici√≥n de una muestra dio una explicaci√≥n excesivamente t√©cnica.";
      }
      if (id === "COM2_RetroCoordinadora") {
        if (op === "A") return "En una conversaci√≥n con la coordinaci√≥n evit√≥ comentar aspectos a mejorar para no incomodar.";
        if (op === "B") return "En una conversaci√≥n con la coordinaci√≥n combin√≥ reconocimiento y sugerencias de mejora.";
        if (op === "C") return "En una conversaci√≥n con la coordinaci√≥n se centr√≥ sobre todo en la queja.";
      }
      if (id === "COM3_CompaneraApagada") {
        if (op === "A") return "Ante se√±ales de posible malestar en una compa√±era prefiri√≥ no intervenir.";
        if (op === "B") return "Ante se√±ales de malestar en una compa√±era abri√≥ un espacio cuidadoso para escucharla.";
        if (op === "C") return "Ante se√±ales de malestar en una compa√±era habl√≥ de ello con terceros m√°s que con ella misma.";
      }

      // EJECUTAR
      if (id === "EJE1_Prioridades") {
        if (op === "A") return "Con varias tareas simult√°neas se dej√≥ llevar por el orden en que iban llegando las demandas.";
        if (op === "B") return "Con varias tareas simult√°neas defini√≥ prioridades y las comunic√≥ de forma clara.";
        if (op === "C") return "Con varias tareas simult√°neas prioriz√≥ la urgencia del supervisor por encima de los pacientes en espera.";
      }
      if (id === "EJE2_CompromisoEntrega") {
        if (op === "A") return "Un informe comprometido para final de turno qued√≥ pospuesto sin avisar.";
        if (op === "B") return "Un informe comprometido para final de turno se entreg√≥ tras avisar que necesitaba unos minutos m√°s.";
        if (op === "C") return "Un informe comprometido se entreg√≥ incompleto para cumplir solo el horario.";
      }
      if (id === "EJE3_AsistenciaPuntualidad") {
        if (op === "A") return "Ante varios retrasos por transporte dio poca prioridad a buscar alternativas o comentarlo.";
        if (op === "B") return "Ante varios retrasos por transporte busc√≥ soluciones y consider√≥ hablarlo abiertamente.";
        if (op === "C") return "Ante varios retrasos por transporte intent√≥ reorganizarse pidiendo cambios sin abordar el fondo del problema.";
      }

      // PSICO
      if (id === "PSICO1_AnsiedadAnticipatoria") {
        if (op === "A") return "En una espera larga la mayor parte del tiempo se centr√≥ en rumiaci√≥n y anticipaci√≥n.";
        if (op === "B") return "En una espera larga trat√≥ de centrarse en lo controlable y mantener rutina.";
        if (op === "C") return "En una espera larga evit√≥ revisar informaci√≥n hasta el final para no angustiarse.";
      }
      if (id === "PSICO2_EstadoAnimo") {
        if (op === "A") return "Ante semanas grises tendi√≥ a normalizar el malestar sin cambios ni conversaci√≥n.";
        if (op === "B") return "Ante semanas grises consider√≥ ajustar h√°bitos y abrir la puerta a pedir ayuda si persiste.";
        if (op === "C") return "Ante semanas grises reaccion√≥ con autoexigencia y autocr√≠tica.";
      }
      if (id === "PSICO3_SuenoCansancio") {
        if (op === "A") return "Frente a cansancio mantenido aument√≥ el uso de estimulantes sin revisar el descanso.";
        if (op === "B") return "Frente a cansancio mantenido revis√≥ horarios y valor√≥ consultar si no mejoraba.";
        if (op === "C") return "Frente a cansancio mantenido redujo actividades sin una estrategia clara.";
      }
      if (id === "PSICO4_AbandonoPuesto") {
        if (op === "A") return "En conflictos laborales tendi√≥ al ausentismo mientras buscaba otras opciones.";
        if (op === "B") return "En conflictos laborales busc√≥ conversaci√≥n y an√°lisis antes de decidir irse.";
        if (op === "C") return "En conflictos laborales prefiri√≥ salidas r√°pidas y directas.";
      }
      if (id === "PSICO5_AutoimagenCompromiso") {
        if (op === "A") return "Se defini√≥ como casi incapaz de abandonar un compromiso incluso si deja de tener sentido.";
        if (op === "B") return "Se defini√≥ como alguien que suele terminar lo que empieza con cierto margen de flexibilidad.";
        if (op === "C") return "Se defini√≥ como alguien con dificultad para llegar al final de lo que inicia.";
      }
      if (id === "PSICO6_ApoyoSocial") {
        if (op === "A") return "Declar√≥ preferir sostener el estr√©s sin que se note ni pedir apoyo.";
        if (op === "B") return "Declar√≥ buscar apoyo en personas de confianza cuando el estr√©s aumenta.";
        if (op === "C") return "Declar√≥ compartir el malestar principalmente en momentos de desborde.";
      }

      return "Tom√≥ una decisi√≥n que aporta matices sobre su forma de actuar en contexto de trabajo y bienestar.";
    }

    // =========================
    // 4. Utilidades
    // =========================
    function shuffleArray(arr) {
      var a = arr.slice();
      for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }
      return a;
    }

    // =========================
    // 5. Flujo principal
    // =========================
    function startSimulation() {
      var input = document.getElementById("participant-id");
      var value = input.value.replace(/^\s+|\s+$/g, "");
      if (!value) {
        alert("Por favor ingresa un ID de jugador (ej. P001).");
        return;
      }

      participantId = value;

      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("scenario-card").classList.remove("hidden");

      currentScenarioIndex = 0;
      responses = [];
      storyLog = [];
      scenarioQueue = [];

      for (var i = 0; i < scenarios.length; i++) {
        scheduleScenario(scenarios[i].id);
      }

      loadScenario();
    }

    function loadScenario() {
      if (currentScenarioIndex >= scenarioQueue.length) {
        endSimulation();
        return;
      }

      var scenarioId = scenarioQueue[currentScenarioIndex];
      var scenario = scenarioMap[scenarioId];

      var titleEl = document.getElementById("scenario-title");
      var textEl = document.getElementById("scenario-text");
      var optionsContainer = document.getElementById("options-container");
      var feedbackEl = document.getElementById("feedback");
      var nextButton = document.getElementById("next-button");
      var progressEl = document.getElementById("progress-text");

      titleEl.textContent = scenario.title;
      textEl.textContent = scenario.text;
      progressEl.textContent = "Misi√≥n " + (currentScenarioIndex + 1) + " de " + scenarioQueue.length;

      optionsContainer.innerHTML = "";
      feedbackEl.textContent = "";
      nextButton.classList.add("hidden");

      var shuffledOptions = shuffleArray(scenario.options);

      for (var i = 0; i < shuffledOptions.length; i++) {
        (function(opt) {
          var btn = document.createElement("button");
          btn.textContent = "‚ñ∂ " + opt.label;
          btn.onclick = function() { handleOptionClick(opt); };
          optionsContainer.appendChild(btn);
        })(shuffledOptions[i]);
      }

      currentQuestionStartTime = new Date().getTime();
    }

    function handleOptionClick(option) {
      var endTime = new Date().getTime();
      var responseTimeMs = endTime - currentQuestionStartTime;

      var scenarioId = scenarioQueue[currentScenarioIndex];
      var scenario = scenarioMap[scenarioId];

      var isCorrect = option.correct === true;

      var record = {
        participant_id: participantId,
        date_time: new Date().toISOString(),
        mission_number: currentScenarioIndex + 1,
        scenario_id: scenario.id,
        scenario_title: scenario.title,
        category: scenario.category,
        dimension: scenario.dimension,
        choice: option.id,
        correct: isCorrect,
        response_time_ms: responseTimeMs
      };
      responses.push(record);

      var fragment = getStoryFragment(scenario, option);
      storyLog.push(fragment);

      var feedbackEl = document.getElementById("feedback");
      feedbackEl.textContent = option.feedback;

      var optionsContainer = document.getElementById("options-container");
      var buttons = optionsContainer.getElementsByTagName("button");
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].disabled = true;
      }

      var nextButton = document.getElementById("next-button");
      nextButton.classList.remove("hidden");
    }

    function nextScenario() {
      currentScenarioIndex++;
      if (currentScenarioIndex < scenarioQueue.length) {
        loadScenario();
      } else {
        endSimulation();
      }
    }

    function endSimulation() {
  document.getElementById("scenario-card").classList.add("hidden");
  document.getElementById("results-card").classList.remove("hidden");

  var summaryEl = document.getElementById("summary");
  summaryEl.innerHTML =
    "<p>Gracias por completar las misiones.</p>" +
    "<p>Puedes avisar a la persona responsable del proceso que ya terminaste.</p>";

  enviarResultados();
}

    // =========================
    // 6. Acceso restringido (contrase√±a SYNLAB)
    // =========================
    function requestAdminAccess() {
      var pwd = prompt("Introduce la contrase√±a de acceso para el equipo de selecci√≥n:");
      if (pwd === null) return;
      if (pwd === "SYNLAB") {
        document.getElementById("download-section").classList.remove("hidden");
        alert("Acceso autorizado.");
      } else {
        alert("Contrase√±a incorrecta.");
      }
    }

    // =========================
    // 7. Exportar CSV con ACCE + PSICO + observaci√≥n clara
    // =========================
    function downloadCSV() {
      if (responses.length === 0) {
        alert("No hay respuestas registradas.");
        return;
      }

      var header = [
        "ID_participante",
        "FechaHora_ISO",
        "Numero_mision",
        "Escenario_nombre",
        "Categoria",
        "Dimension",
        "Opcion_elegida",
        "Respuesta_adecuada",
        "Tiempo_respuesta_segundos"
      ];

      var rows = [];
      var total = responses.length;
      var correctCount = 0;

      // ACCE
      var compStats = {
        AGIL: {total:0, incorrect:0},
        CONECTAR: {total:0, incorrect:0},
        COMUNICAR: {total:0, incorrect:0},
        EJECUTAR: {total:0, incorrect:0}
      };

      // PSICO
      var psicoTotal = 0;
      var psicoIncorrect = 0;
      var riesgoAnsiedad = false;
      var riesgoDepresion = false;
      var riesgoAbandono = false;

      for (var i = 0; i < responses.length; i++) {
        var r = responses[i];

        var esAdecuada = r.correct ? "SI" : "NO";
        var tiempoSeg = Math.round((r.response_time_ms / 100)) / 10;

        rows.push([
          r.participant_id,
          r.date_time,
          r.mission_number,
          r.scenario_title,
          r.category,
          r.dimension,
          r.choice,
          esAdecuada,
          tiempoSeg
        ]);

        if (r.correct) correctCount++;

        if (compStats[r.category]) {
          compStats[r.category].total++;
          if (!r.correct) compStats[r.category].incorrect++;
        }

        if (r.category === "PSICO") {
          psicoTotal++;
          if (!r.correct) psicoIncorrect++;

          if (!r.correct && r.dimension === "ansiedad_anticipatoria") {
            riesgoAnsiedad = true;
          }
          if (!r.correct && (r.dimension === "estado_animo_bajo" || r.dimension === "autocuidado_basico")) {
            riesgoDepresion = true;
          }
          if (!r.correct && r.dimension === "abandono_puesto") {
            riesgoAbandono = true;
          }
        }
      }

      var incorrectCount = total - correctCount;
      var globalAcc = total > 0 ? Math.round((correctCount / total) * 1000) / 10 : 0;

      function calcAcc(cat) {
        var s = compStats[cat];
        if (!s || s.total === 0) return null;
        return Math.round(((s.total - s.incorrect) / s.total) * 1000) / 10;
      }

      var agilAcc = calcAcc("AGIL");
      var conectarAcc = calcAcc("CONECTAR");
      var comunicarAcc = calcAcc("COMUNICAR");
      var ejecutarAcc = calcAcc("EJECUTAR");

      var psicoAcc = psicoTotal > 0
        ? Math.round(((psicoTotal - psicoIncorrect) / psicoTotal) * 1000) / 10
        : null;

      var minComp = 100;
      ["AGIL","CONECTAR","COMUNICAR","EJECUTAR"].forEach(function(c){
        var v = calcAcc(c);
        if (v !== null && v < minComp) minComp = v;
      });
      if (minComp === 100 && total === 0) minComp = 0;

      // APTITUD global
      var aptitud = "";
      if (globalAcc >= 75 && minComp >= 60 && (!riesgoAbandono)) {
        aptitud = "APTO";
      } else if (globalAcc >= 55 && minComp >= 45) {
        aptitud = "EN OBSERVACION";
      } else {
        aptitud = "NO APTO (estimado)";
      }

      // FORTALEZAS / A DESARROLLAR ACCE
      var fortalezas = [];
      var desarrollo = [];

      function checkComp(nombreVisible, catAcc) {
        if (catAcc === null) return;
        if (catAcc >= 70) {
          fortalezas.push(nombreVisible + " (" + catAcc + "%)");
        } else if (catAcc < 60) {
          desarrollo.push(nombreVisible + " (" + catAcc + "%)");
        }
      }

      checkComp("√Ågil", agilAcc);
      checkComp("Conectar", conectarAcc);
      checkComp("Comunicar", comunicarAcc);
      checkComp("Ejecutar", ejecutarAcc);

      // OBSERVACI√ìN detallada en lenguaje llano
      var obs = [];

      obs.push(
        "Este resultado es una estimaci√≥n basada en un juego de decisiones. No es un diagn√≥stico psicol√≥gico ni reemplaza una evaluaci√≥n cl√≠nica completa, pero s√≠ ofrece una fotograf√≠a √∫til para procesos de selecci√≥n."
      );

      obs.push(
        "En el conjunto de misiones la persona acierta en aproximadamente " + globalAcc + "% de las situaciones planteadas."
      );

      // explicaci√≥n de aptitud
      if (aptitud === "APTO") {
        obs.push(
          "Se considera APTO porque, en general, sus decisiones se alinean con lo esperado para el rol: cuida al paciente, coopera con otros, se comunica de forma respetuosa y organiza su trabajo con cierto criterio de prioridad y cumplimiento."
        );
      } else if (aptitud === "EN OBSERVACION") {
        obs.push(
          "Se clasifica EN OBSERVACI√ìN porque combina decisiones adecuadas con otras que dejan dudas sobre c√≥mo responde bajo presi√≥n, c√≥mo maneja la frustraci√≥n o c√≥mo sostiene sus compromisos. No es un perfil descartable, pero s√≠ requiere una entrevista m√°s profunda y seguimiento cercano en periodo de prueba."
        );
      } else {
        obs.push(
          "Se clasifica como NO APTO (estimado) para este tipo de rol porque aparecen varias decisiones que, si se trasladan a la pr√°ctica diaria, podr√≠an generar dificultades importantes en servicio al paciente, trabajo en equipo o cumplimiento b√°sico de horarios y acuerdos."
        );
      }

      // explicaci√≥n ACCE una por una
      function describeComp(nombre, acc, textoAlta, textoMedia, textoBaja) {
        if (acc === null) return;
        if (acc >= 70) {
          obs.push("En la competencia " + nombre + " (aprox. " + acc + "% de decisiones adecuadas), se observa " + textoAlta);
        } else if (acc >= 55) {
          obs.push("En la competencia " + nombre + " (aprox. " + acc + "%), el funcionamiento es intermedio: " + textoMedia);
        } else {
          obs.push("En la competencia " + nombre + " (por debajo del 55%, aprox. " + acc + "%), aparecen varias decisiones de riesgo: " + textoBaja);
        }
      }

      describeComp(
        "√Ågil",
        agilAcc,
        "capacidad razonable para adaptarse a cambios, escuchar la situaci√≥n y buscar alternativas sin perder de vista la seguridad.",
        "a veces se adapta bien y otras se queda en la queja o la rigidez; conviene acompa√±ar su proceso de ajuste a cambios de turnos o sistemas.",
        "tendencia a responder con rigidez, queja o improvisaciones arriesgadas cuando el contexto cambia; podr√≠a costarle integrarse a un entorno din√°mico."
      );

      describeComp(
        "Conectar",
        conectarAcc,
        "una buena disposici√≥n para colaborar, apoyar a compa√±eros y construir puentes con otros servicios cuando hay problemas.",
        "muestra algunos gestos de colaboraci√≥n, pero en otros momentos se distancia o deja los temas en manos de otros; el trabajo transversal podr√≠a requerir gu√≠a.",
        "poca iniciativa para ayudar, compartir pr√°cticas o dialogar con otras √°reas ante conflictos; esto puede limitar la integraci√≥n con el resto del equipo y con m√©dicos/negocio."
      );

      describeComp(
        "Comunicar",
        comunicarAcc,
        "una comunicaci√≥n generalmente clara y respetuosa, con capacidad de explicar situaciones a pacientes y de abrir conversaciones con el equipo.",
        "algunas respuestas muestran empat√≠a y claridad, pero otras se quedan cortas o se centran en la queja; importante acompa√±ar habilidades de feedback y escucha.",
        "tendencia a evitar conversaciones dif√≠ciles, a dar explicaciones muy escuetas o a comentar problemas m√°s con terceros que con los implicados; puede impactar en clima y en experiencia de pacientes."
      );

      describeComp(
        "Ejecutar",
        ejecutarAcc,
        "sentido aceptable de prioridad y compromiso: organiza tareas, intenta cumplir lo que promete y busca soluciones cuando algo se complica.",
        "mezcla decisiones ordenadas con otras donde se pierde la prioridad o se posponen compromisos; conviene reforzar h√°bitos de planificaci√≥n y seguimiento.",
        "varias escenas apuntan a dificultades para priorizar, sostener acuerdos o ser consistente con horarios; esto puede traducirse en fallos en la operaci√≥n diaria."
      );

      // bloque psico
      if (psicoAcc !== null) {
        obs.push(
          "En el bloque de bienestar psicol√≥gico y estabilidad laboral (ansiedad, estado de √°nimo, autocuidado y abandono), las decisiones consideradas m√°s protectoras se sit√∫an en torno a " + psicoAcc + "%."
        );
      }

      if (riesgoAnsiedad) {
        obs.push(
          "Las respuestas relacionadas con la espera de noticias y la forma de manejar la incertidumbre sugieren un estilo algo m√°s ansioso (rumiaci√≥n, anticipaci√≥n o evitaci√≥n de informaci√≥n). En un contexto asistencial puede traducirse en mayor desgaste mental y dificultad para desconectar al finalizar la jornada."
        );
      } else {
        obs.push(
          "No se observan indicadores claros de un afrontamiento muy ansioso ante la incertidumbre en las escenas planteadas; aun as√≠, el contexto real siempre puede amplificar rasgos previos."
        );
      }

      if (riesgoDepresion) {
        obs.push(
          "En escenas de estado de √°nimo y cansancio aparecen decisiones que normalizan malestares prolongados, se apoyan en la autoexigencia o postergan el autocuidado. Esto aumenta el riesgo de s√≠ntomas ansioso-depresivos o de caer en un estilo de 'aguantar' m√°s de lo saludable antes de pedir ayuda."
        );
      } else {
        obs.push(
          "En cuanto a estado de √°nimo y autocuidado b√°sico, las respuestas tienden a reconocer el cansancio y a contemplar ajustes de rutina o b√∫squeda de ayuda, lo que funciona como factor protector frente a ansiedad y depresi√≥n."
        );
      }

      if (riesgoAbandono) {
        obs.push(
          "En las escenas relacionadas con conflictos laborales y desajustes en el entorno, se observan opciones que facilitan el ausentismo, la renuncia r√°pida o el corte brusco del v√≠nculo cuando hay dificultades. Esto incrementa el riesgo de deserci√≥n laboral temprana si el contexto no acompa√±a o si se dan varios roces seguidos."
        );
      } else {
        obs.push(
          "En la parte de estabilidad en el puesto, aparecen decisiones que dan lugar primero al di√°logo y a la b√∫squeda de ajustes antes de pensar en irse, lo que reduce el riesgo de abandono impulsivo del puesto."
        );
      }

      if (fortalezas.length > 0) {
        obs.push(
          "Fortalezas a destacar (seg√∫n el juego): " + fortalezas.join("; ") + "."
        );
      }

      if (desarrollo.length > 0) {
        obs.push(
          "Aspectos a reforzar: " + desarrollo.join("; ") + ". Son temas concretos que pueden trabajarse en la inducci√≥n, el acompa√±amiento inicial y la retroalimentaci√≥n continua."
        );
      }

      obs.push(
        "Recomendaci√≥n de uso: integrar esta informaci√≥n con la entrevista, referencias laborales y, cuando sea necesario, valoraci√≥n cl√≠nica formal. El juego ayuda a ver tendencias, pero no define por s√≠ solo la decisi√≥n final."
      );

      obs.push(
        "Motivo de la etiqueta final: la clasificaci√≥n APTO / EN OBSERVACI√ìN / NO APTO (estimado) se construye a partir del porcentaje global de decisiones adecuadas, el equilibrio entre las competencias ACCE (√Ågil, Conectar, Comunicar, Ejecutar) y la presencia o no de indicadores de riesgo psicol√≥gico y de abandono."
      );

      var observacion = obs.join(" ");

      // Filas de resumen
      var resumenGlobal1 = [
        "RESUMEN_GLOBAL","","","","","","",
        "Total_misiones", total, ""
      ];
      var resumenGlobal2 = [
        "RESUMEN_GLOBAL","","","","","","",
        "Respondio_adecuadamente", correctCount, ""
      ];
      var resumenGlobal3 = [
        "RESUMEN_GLOBAL","","","","","","",
        "Respondio_con_riesgo", incorrectCount, ""
      ];
      var resumenGlobal4 = [
        "RESUMEN_GLOBAL","","","","","","",
        "Porcentaje_aciertos", globalAcc + "%", ""
      ];

      var resumenAgil = [
        "RESUMEN_ACCE","","","","","","",
        "AGIL",
        (agilAcc === null ? "Sin datos" :
          "Errores: " + compStats.AGIL.incorrect + " de " + compStats.AGIL.total +
          " (" + agilAcc + "% decisiones adecuadas)"),
        ""
      ];
      var resumenConectar = [
        "RESUMEN_ACCE","","","","","","",
        "CONECTAR",
        (conectarAcc === null ? "Sin datos" :
          "Errores: " + compStats.CONECTAR.incorrect + " de " + compStats.CONECTAR.total +
          " (" + conectarAcc + "% decisiones adecuadas)"),
        ""
      ];
      var resumenComunicar = [
        "RESUMEN_ACCE","","","","","","",
        "COMUNICAR",
        (comunicarAcc === null ? "Sin datos" :
          "Errores: " + compStats.COMUNICAR.incorrect + " de " + compStats.COMUNICAR.total +
          " (" + comunicarAcc + "% decisiones adecuadas)"),
        ""
      ];
      var resumenEjecutar = [
        "RESUMEN_ACCE","","","","","","",
        "EJECUTAR",
        (ejecutarAcc === null ? "Sin datos" :
          "Errores: " + compStats.EJECUTAR.incorrect + " de " + compStats.EJECUTAR.total +
          " (" + ejecutarAcc + "% decisiones adecuadas)"),
        ""
      ];

      var resumenPsico = [
        "RESUMEN_PSICO","","","","","","",
        "Bloque_psicologico",
        (psicoAcc === null ? "Sin datos" :
          "Respuestas de mayor riesgo: " + psicoIncorrect + " de " + psicoTotal +
          " (" + psicoAcc + "% decisiones protectoras)"),
        ""
      ];

      var filaAptitud = [
        "APTITUD","","","","","","",
        "Aptitud_estimada", aptitud, ""
      ];

      var filaObservacion = [
        "OBSERVACION","","","","","","",
        "Comentario", observacion, ""
      ];

      var filaHistoria = [
        "HISTORIA","","","","","","",
        "Relato_resumido", storyLog.join(" "), ""
      ];

      var definicionACCE = [
        "DEFINICION_ITEM","","","","","","",
        "ACCE",
        "Modelo de competencias SYNLAB ACCE nivel 1: √Ågil (escucha al cliente, se adapta e innova), Conectar (colabora a trav√©s de equipos y construye puentes), Comunicar (explica, escucha y muestra empat√≠a) y Ejecutar (establece metas, cuida resultados y cumple promesas). Las misiones del juego traducen estas competencias en decisiones concretas del d√≠a a d√≠a de un rol asistencial.",
        ""
      ];

      var definicionPSICO = [
        "DEFINICION_ITEM","","","","","","",
        "PSICO",
        "El bloque psicol√≥gico explora de forma indirecta estilos de afrontamiento ante ansiedad, estado de √°nimo bajo, autocuidado y abandono del puesto. No son escalas cl√≠nicas oficiales, pero se inspiran en constructos usados en instrumentos como el GAD-7 (ansiedad), PHQ-9 (depresi√≥n) y en criterios de estabilidad laboral.",
        ""
      ];

      // FUENTES PSICOL√ìGICAS (manteniendo APA y otras)
      var fuente1 = [
        "FUENTES_PSICOLOGICAS","","","","","","",
        "Fuente_1",
        "American Psychological Association (APA). APA Dictionary of Psychology: conceptos de ansiedad, depresi√≥n, afrontamiento y fiabilidad.",
        ""
      ];
      var fuente2 = [
        "FUENTES_PSICOLOGICAS","","","","","","",
        "Fuente_2",
        "Nunnally, J. C., & Bernstein, I. H. (1994). Psychometric Theory. McGraw-Hill.",
        ""
      ];
      var fuente3 = [
        "FUENTES_PSICOLOGICAS","","","","","","",
        "Fuente_3",
        "Spitzer, R. L., Kroenke, K., Williams, J. B. W., & L√∂we, B. (2006). GAD-7: medida breve para ansiedad generalizada.",
        ""
      ];
      var fuente4 = [
        "FUENTES_PSICOLOGICAS","","","","","","",
        "Fuente_4",
        "Kroenke, K., Spitzer, R. L., & Williams, J. B. W. (2001). PHQ-9: escala breve de depresi√≥n.",
        ""
      ];
      var fuenteNota = [
        "FUENTES_PSICOLOGICAS","","","","","","",
        "Nota",
        "El simulador se inspira en estos marcos (ansiedad, depresi√≥n, afrontamiento, estabilidad laboral y competencias) pero NO equivale a estas pruebas ni debe usarse para diagn√≥stico cl√≠nico.",
        ""
      ];

      var csvContent = header.join(",") + "\n";
      for (var m = 0; m < rows.length; m++) {
        csvContent += rows[m].join(",") + "\n";
      }

      csvContent += "\n" + resumenGlobal1.join(",") + "\n";
      csvContent += resumenGlobal2.join(",") + "\n";
      csvContent += resumenGlobal3.join(",") + "\n";
      csvContent += resumenGlobal4.join(",") + "\n";
      csvContent += resumenAgil.join(",") + "\n";
      csvContent += resumenConectar.join(",") + "\n";
      csvContent += resumenComunicar.join(",") + "\n";
      csvContent += resumenEjecutar.join(",") + "\n";
      csvContent += resumenPsico.join(",") + "\n";
      csvContent += filaAptitud.join(",") + "\n";
      csvContent += filaObservacion.join(",") + "\n";
      csvContent += filaHistoria.join(",") + "\n";
      csvContent += definicionACCE.join(",") + "\n";
      csvContent += definicionPSICO.join(",") + "\n";
      csvContent += fuente1.join(",") + "\n";
      csvContent += fuente2.join(",") + "\n";
      csvContent += fuente3.join(",") + "\n";
      csvContent += fuente4.join(",") + "\n";
      csvContent += fuenteNota.join(",") + "\n";

      // BOM para que Excel respete acentos
      csvContent = "\uFEFF" + csvContent;

      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var link = document.createElement("a");
      var filename = "resultados_misiones_" + participantId + ".csv";

      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
// ======================================================================
//  ENV√çO AUTOM√ÅTICO A GOOGLE SHEET (AGREGADO EXACTAMENTE COMO LO PEDISTE)
// ======================================================================

function construirInformeFinal() {
// OBSERVACI√ìN COMPLETA (t√©cnica, estilo SYNLAB, din√°mica)
let observacion = 
  "Este resultado es una estimaci√≥n basada en un juego de decisiones. No reemplaza una evaluaci√≥n cl√≠nica formal, " +
  "pero permite identificar patrones relevantes de toma de decisiones en escenarios laborales y de presi√≥n.\n\n" +

  "‚úî En el an√°lisis global, la persona acierta en aproximadamente " + porcentaje + "%. " +
  "Esto indica un patr√≥n " + (porcentaje >= 70 ? "funcional" : porcentaje >= 55 ? "mixto" : "de riesgo") + " en toma de decisiones.\n\n" +

  "‚úî En la competencia √ÅGIL, se observa: " + AG.texto + ". " +
  (AG.acc < 55 
    ? "Esto sugiere posibles dificultades para adaptarse a cambios r√°pidos, priorizar bajo presi√≥n y responder con flexibilidad." 
    : "Se observan respuestas alineadas con la adaptabilidad operativa y la toma de decisiones pragm√°tica.") + "\n\n" +

  "‚úî En la competencia CONECTAR, se observa: " + CO.texto + ". " +
  (CO.acc < 55 
    ? "Esto puede reflejar retos en construcci√≥n de relaciones efectivas, manejo de quejas o articulaci√≥n con otros actores del servicio." 
    : "Las respuestas indican buena disposici√≥n para trabajar con otros y construir puentes funcionales.") + "\n\n" +

  "‚úî En la competencia COMUNICAR, se observa: " + CM.texto + ". " +
  (CM.acc < 55 
    ? "El patr√≥n evidencia riesgo en comunicaci√≥n clara bajo presi√≥n, manejo de emociones del usuario o transmisi√≥n efectiva de informaci√≥n." 
    : "Muestra claridad comunicativa, manejo de objeciones y ajuste del discurso al contexto.") + "\n\n" +

  "‚úî En la competencia EJECUTAR, se observa: " + EJ.texto + ". " +
  (EJ.acc < 55 
    ? "Esto indica riesgo en seguimiento de prioridades, cumplimiento estable y disciplina operativa." 
    : "Las decisiones evidencian priorizaci√≥n adecuada, orden y orientaci√≥n al resultado.") + "\n\n" +

  "‚úî En el bloque psicol√≥gico aparecen " + psicoInc + " decisiones de riesgo sobre " + psicoTot + ". " +
  (psicoInc >= 3
    ? "Esto sugiere se√±ales de vulnerabilidad emocional, posible anticipaci√≥n ansiosa o dificultades para sostener estabilidad bajo carga." 
    : "Predominan decisiones protectoras y manejo emocional adecuado en escenarios retadores.") + "\n\n" +

  "En conjunto, la aptitud estimada es: " + aptitud + ". " +
  (aptitud === "NO APTO (estimado)"
    ? "Esto se concluye porque los patrones de riesgo en ACCE o en el bloque psicol√≥gico podr√≠an afectar la calidad del servicio, el trabajo en equipo o la estabilidad laboral."
    : aptitud === "EN OBSERVACION"
    ? "Se recomienda observar de cerca durante el periodo de prueba, especialmente en situaciones de presi√≥n o variabilidad."
    : "El perfil evidencia recursos adecuados para el rol y decisiones consistentes.");
  // Total respuestas
  let total = responses.length;
  let correctas = responses.filter(r => r.correct).length;
  let incorrectas = total - correctas;
  let porcentaje = total === 0 ? 0 : Math.round((correctas / total) * 1000) / 10;

  // Historia unida
  let historia = storyLog.join(" ");

  // RESUMEN ACCE
  function calcDim(cat) {
    let tot = responses.filter(r => r.category === cat).length;
    let inc = responses.filter(r => r.category === cat && !r.correct).length;
    let acc = tot === 0 ? 0 : Math.round(((tot - inc) / tot) * 1000) / 10;
    return {
      texto: `Errores: ${inc} de ${tot} (${acc}% decisiones adecuadas)`,
      acc: acc
    };
  }

  let AG = calcDim("AGIL");
  let CO = calcDim("CONECTAR");
  let CM = calcDim("COMUNICAR");
  let EJ = calcDim("EJECUTAR");

  // PSICO
  let psicoTot = responses.filter(r => r.category === "PSICO").length;
  let psicoInc = responses.filter(r => r.category === "PSICO" && !r.correct).length;
  let psicoAcc = psicoTot === 0 ? 0 : Math.round(((psicoTot - psicoInc) / psicoTot) * 1000) / 10;

  // APTITUD
  let minACCE = Math.min(AG.acc, CO.acc, CM.acc, EJ.acc);
  let aptitud = "NO APTO (estimado)";
  if (porcentaje >= 75 && minACCE >= 60) aptitud = "APTO";
  else if (porcentaje >= 55 && minACCE >= 45) aptitud = "EN OBSERVACION";

  // OBSERVACI√ìN (resumen autom√°tico)
  let observacion =
    `Este resultado es una estimaci√≥n basada en un juego de decisiones. ` +
    `La persona acierta en aproximadamente ${porcentaje}%. ` +
    `Aptitud estimada: ${aptitud}. ` +
    `AGIL: ${AG.texto}. ` +
    `CONECTAR: ${CO.texto}. ` +
    `COMUNICAR: ${CM.texto}. ` +
    `EJECUTAR: ${EJ.texto}. ` +
    `PSICO: Respuestas de mayor riesgo: ${psicoInc} de ${psicoTot} (${psicoAcc}% decisiones protectoras).`;

  return {
    id_participante: participantId,
    fecha_hora: new Date().toISOString(),
    resumen_global: `Total: ${total}. Adecuadas: ${correctas}. Riesgo: ${incorrectas}. % aciertos: ${porcentaje}%.`,
    resumen_acce:
      `AGIL: ${AG.texto} | ` +
      `CONECTAR: ${CO.texto} | ` +
      `COMUNICAR: ${CM.texto} | ` +
      `EJECUTAR: ${EJ.texto}`,
    resumen_psico:
      `Riesgo: ${psicoInc} de ${psicoTot} (${psicoAcc}% decisiones protectoras)`,
    aptitud: aptitud,
    observacion: observacion,
    historia: historia,
    json_respuestas: responses
  };
}

function enviarResultados() {
  const endpoint =
    "https://script.google.com/macros/s/AKfycbzLsPAAYmwnX2kohFyNsDYtgFpRuJTQue5AnTfdT680Wmik3kI2zdzi0S50BX3HLWDy0w/exec";

  let informe = construirInformeFinal(); // ‚Üê AQUI SE CREA EL INFORME COMPLETO

  fetch(endpoint, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(informe)
  })
    .then(() => console.log("‚úî Informe enviado al Google Sheet"))
    .catch(err => console.error("Error:", err));
}
  </script>
</body>
</html>